<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…åŠäº‹é¡¹åˆ—è¡¨</title>
    <!-- æ›¿æ¢åŸ <head> é‡Œçš„ <style> éƒ¨åˆ† -->
<style>
* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            padding: 20px;
            min-height: 100vh;
            color: #2c3e50;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .header {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            color: #1a237e;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2.2rem;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, #2196F3, #21CBF3);
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    button.toggle-on{background:linear-gradient(135deg,#4CAF50,#8BC34A)}
    button.toggle-off{background:linear-gradient(135deg,#FF9800,#FFC107)}

    /* 3. äº‹é¡¹å¡ç‰‡ */
    .todo-item{
        background:#fff;
        border-radius:8px;
        padding:12px;
        margin-bottom:10px;
        box-shadow:0 1px 3px rgba(0,0,0,.08);
    }
    .todo-header{
        display:flex;
        justify-content:space-between;
        font-size:13px;
        color:#666;
        margin-bottom:6px;
    }
    .todo-title{
        font-size:17px;
        font-weight:600;
        color:#1a237e;
    }
    .todo-details{
        margin-top:6px;
        font-size:14px;
        color:#555;
        white-space:pre-wrap;
        word-break:break-word;
    }
    .plan-date.upcoming{color:#2e7d32}
    .plan-date.overdue{color:#c62828}

    /* 4. æ¨¡æ€æ¡†é€‚é… */
    .modal{
        display:none;
        position:fixed;
        top:0;left:0;
        width:100%;height:100%;
        background:rgba(0,0,0,.45);
        z-index:999;
    }
    .modal-content{
        position:relative;
        background:#fff;
        margin:10vh auto 0;
        width:92%;
        max-width:400px;
        max-height:80vh;
        border-radius:12px;
        overflow:hidden;
        display:flex;
        flex-direction:column;
    }
    .modal-content h3{
        flex-shrink:0;
        padding:14px 16px;
        font-size:18px;
        background:#2196F3;
        color:#fff;
    }
    #todoForm{
        flex:1 1 auto;
        overflow-y:auto;
        padding:12px 16px 20px;
    }
    .form-group{
        margin-bottom:12px;
    }
    .form-group label{
        display:block;
        margin-bottom:4px;
        font-size:14px;
        font-weight:600;
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
        width:100%;
        padding:10px 12px;
        border:1px solid #cfd8dc;
        border-radius:6px;
        font-size:15px;
    }
    .form-group textarea{min-height:70px;resize:vertical}
    .close{
        position:absolute;
        right:12px;top:10px;
        font-size:26px;
        color:#fff;
        line-height:1;
        padding:4px 8px;
    }
	/* æœç´¢é¢æ¿å¤é€‰æ¡†ä¿®å¤ */
#searchDetails {
  -webkit-appearance: checkbox;   /* å¼ºåˆ¶æ˜¾ç¤ºåŸç”Ÿå‹¾é€‰æ¡† */
  appearance: checkbox;
  width: auto;
  margin-right: 6px;
  vertical-align: middle;
}
    .file-input{display:none}
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¾…åŠäº‹é¡¹åˆ—è¡¨</h1>
            <div class="button-group">
                <button onclick="showNewModal()">æ–°å»º</button>
                <button id="toggleDetails" class="toggle-off" onclick="toggleDetails()">æ˜¾ç¤ºç»†èŠ‚</button>
				<button onclick="showSearchModal()">ğŸ” æœç´¢</button>
                <button onclick="exportList()">è¾“å‡ºåˆ—è¡¨</button>
                <button onclick="importList()">å¯¼å…¥åˆ—è¡¨</button>
            </div>
        </div>
        
        <div class="todo-list" id="todoList"></div>
    </div>
    <!-- 2. æœç´¢é¢æ¿ï¼ˆä¸æ–°å»ºé¢æ¿åŒçº§ï¼Œæœ€å¤–å±‚ï¼‰ -->
	<div id="searchModal" class="modal">
	  <div class="modal-content">
		<span class="close" onclick="closeSearchModal()">&times;</span>
		<h3>æœç´¢äº‹é¡¹</h3>

		<div >
		  <input type="text" id="searchKey" placeholder="è¾“å…¥å…³é”®è¯">

		  <label><input type="checkbox" id="searchDetails"> åŒæ—¶æœç´¢ç»†èŠ‚</label>
		</div>
		<button onclick="runSearch()">å¼€å§‹æœç´¢</button>
	  </div>
	</div>
    <!-- æ–°å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">æ–°å»ºäº‹é¡¹</h3>
            <form id="todoForm">
                <div class="form-group">
                    <label for="title">äº‹é¡¹åç§°ï¼š</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-group">
                    <label for="details">ç»†èŠ‚ï¼š</label>
                    <textarea id="details" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="createTime">åˆ›å»ºæ—¶é—´ï¼š</label>
                    <input type="datetime-local" id="createTime" required>
                </div>
                
                <div class="form-group">
                    <label for="planTime">è®¡åˆ’å®Œæˆæ—¶é—´ï¼š</label>
                    <input type="datetime-local" id="planTime">
                </div>
                
                <div class="form-group">
                    <label for="isCompleted">æ˜¯å¦å®Œæˆï¼š</label>
                    <select id="isCompleted">
                        <option value="false">æœªå®Œæˆ</option>
                        <option value="true">å®Œæˆ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reason">æœªå®ŒæˆåŸå› ï¼š</label>
                    <input type="text" id="reason">
                </div>
                
                <div class="form-group">
                    <label for="notes">å¤‡æ³¨ï¼š</label>
                    <input type="text" id="notes">
                </div>
                
                <div class="form-group">
                    <label for="status">çŠ¶æ€ï¼š</label>
                    <select id="status">
                        <option value="normal">æ­£å¸¸</option>
                        <option value="closed">å…³é—­</option>
                    </select>
                </div>
                
                <!-- æ”¾åœ¨ä¿å­˜æŒ‰é’®åŒä¸€æ’ -->
<div style="display:flex;gap:8px;margin-top:12px">
  <button type="submit" style="flex:1">ä¿å­˜</button>
  <button type="button" onclick="delCurrentTodo()" style="flex:1;background:linear-gradient(135deg,#f44336,#d32f2f)">åˆ é™¤</button>
</div>
            </form>
        </div>
    </div>
    
    <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileImport(event)">
    
    <script>
        let todos = [];
        let showDetails = false;
        let editingId = null;
        
        // åˆå§‹åŒ–
        window.onload = function() {
            loadTodos();
            renderTodos();
            document.getElementById('todoForm').addEventListener('submit', saveTodo);
        };
        
        // ä»localStorageåŠ è½½æ•°æ®
        function loadTodos() {
            const saved = localStorage.getItem('todos');
            if (saved) {
                todos = JSON.parse(saved);
            }
        }
        
        // ä¿å­˜åˆ°localStorage
        function saveTodos() {
            localStorage.setItem('todos', JSON.stringify(todos));
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º MMæœˆDDæ—¥
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }
        
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦è¿‡æœŸ
        function isOverdue(planTime) {
            if (!planTime) return false;
            const now = new Date();
            const plan = new Date(planTime);
            // å°†æ—¶é—´è®¾ç½®ä¸ºå½“å¤©çš„23:59:59ï¼Œè¿™æ ·å½“å¤©ä¸ç®—è¿‡æœŸ
            plan.setHours(23, 59, 59, 999);
            return now > plan;
        }
        
        // æ¸²æŸ“å¾…åŠäº‹é¡¹åˆ—è¡¨
        
        
        // æ˜¾ç¤ºæ–°å»ºæ¨¡æ€æ¡†
        // æ–°å»ºäº‹é¡¹æ—¶ï¼ŒæŠŠâ€œåˆ›å»ºæ—¶é—´â€é»˜è®¤è®¾ä¸ºå½“å‰æœ¬åœ°æ—¶é—´
        function showNewModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'æ–°å»ºäº‹é¡¹';
            document.getElementById('todoForm').reset();

            /* å…³é”®ä¿®å¤ï¼šæœ¬åœ°æ—¶é—´è€Œé UTC */
            const local = new Date();
            const yyyy = local.getFullYear();
            const mm = String(local.getMonth() + 1).padStart(2, '0');
            const dd = String(local.getDate()).padStart(2, '0');
            const hh = String(local.getHours()).padStart(2, '0');
            const min = String(local.getMinutes()).padStart(2, '0');
            document.getElementById('createTime').value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;

            document.getElementById('modal').style.display = 'block';
        }
        
        // ç¼–è¾‘äº‹é¡¹
        function editTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;
            
            editingId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘äº‹é¡¹';
            document.getElementById('title').value = todo.title;
            document.getElementById('details').value = todo.details || '';
            document.getElementById('createTime').value = todo.createTime;
            document.getElementById('planTime').value = todo.planTime || '';
            document.getElementById('isCompleted').value = todo.isCompleted.toString();
            document.getElementById('reason').value = todo.reason || '';
            document.getElementById('notes').value = todo.notes || '';
            document.getElementById('status').value = todo.status;
            document.getElementById('modal').style.display = 'block';
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // ä¿å­˜äº‹é¡¹
        function saveTodo(e) {
            e.preventDefault();
            
            const todo = {
                id: editingId || Date.now(),
                title: document.getElementById('title').value,
                details: document.getElementById('details').value,
                createTime: document.getElementById('createTime').value,
                planTime: document.getElementById('planTime').value,
                isCompleted: document.getElementById('isCompleted').value === 'true',
                reason: document.getElementById('reason').value,
                notes: document.getElementById('notes').value,
                status: document.getElementById('status').value
            };
            
            if (editingId) {
                const index = todos.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    todos[index] = todo;
                }
            } else {
                todos.push(todo);
            }
            
            saveTodos();
            renderTodos();
            closeModal();
        }
        
        // åˆ‡æ¢æ˜¾ç¤ºç»†èŠ‚
        function toggleDetails() {
            showDetails = !showDetails;
            const btn = document.getElementById('toggleDetails');
            btn.textContent = showDetails ? 'éšè—ç»†èŠ‚' : 'æ˜¾ç¤ºç»†èŠ‚';
            btn.className = showDetails ? 'toggle-on' : 'toggle-off';
            renderTodos();
        }
        
        // å¯¼å‡ºåˆ—è¡¨
        function exportList() {
            const dataStr = JSON.stringify(todos, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            link.href = url;
            link.download = `å¾…åŠäº‹é¡¹åˆ—è¡¨${date}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // å¯¼å…¥åˆ—è¡¨
        function importList() {
            document.getElementById('fileInput').click();
        }
        
        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedTodos = JSON.parse(e.target.result);
                    if (Array.isArray(importedTodos)) {
                        // åˆå¹¶æ•°æ®ï¼Œé¿å…é‡å¤
                        importedTodos.forEach(newTodo => {
                            const existingIndex = todos.findIndex(t => t.id === newTodo.id);
                            if (existingIndex === -1) {
                                todos.push(newTodo);
                            }
                        });
                        saveTodos();
                        renderTodos();
                        alert('å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                    }
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
		/* ---------- æœç´¢ç›¸å…³ ---------- */
	let searchKey   = '';          // å½“å‰å…³é”®è¯
	let searchInDet = false;       // æ˜¯å¦æœç´¢ç»†èŠ‚

	function showSearchModal(){
	  document.getElementById('searchModal').style.display = 'block';
	}
	function closeSearchModal(){
	  document.getElementById('searchModal').style.display = 'none';
	}

	function runSearch(){
	  searchKey   = document.getElementById('searchKey').value;
	  searchInDet = document.getElementById('searchDetails').checked;
	  closeSearchModal();
	  renderTodos();               // å¤ç”¨åŸæ¸²æŸ“
	}
function doFilter(key, searchDetails) {
  const k = key.trim().toLowerCase();
  if (!k) return todos;                       // ç©ºå…³é”®è¯è¿”å›å…¨éƒ¨
  return todos.filter(t => {
    const inTitle  = t.title.toLowerCase().includes(k);
    const inDetail = searchDetails && t.details && t.details.toLowerCase().includes(k);
    return inTitle || inDetail;
  });
}
	/* é‡å†™/æ›¿æ¢åŸæ¥çš„ renderTodos() å¤´éƒ¨ä¸¤å¥å³å¯ */
	function renderTodos(){
  const list = document.getElementById('todoList');
  list.innerHTML = '';

  /* åªè¦å…³é”®è¯éç©ºå°±è¿‡æ»¤ï¼›å¦åˆ™æ‹¿å…¨éƒ¨ */
  const base = searchKey.trim() ? doFilter(searchKey, searchInDet) : todos;
  const showTodos = base.filter(t => t.status === 'normal');

	  showTodos.forEach(t=>{
		 // â€¦ ä»¥ä¸‹ä¸åŸæ¸²æŸ“é€»è¾‘å®Œå…¨ä¸€è‡´ â€¦
		 const item = document.createElement('div');
		 item.className = 'todo-item';
		 item.onclick = () => editTodo(t.id);

		 let html = `
		   <div class="todo-header">
			 <div class="todo-date create-date">${formatDate(t.createTime)}</div>
			 <div class="todo-date plan-date ${t.planTime ? (isOverdue(t.planTime)?'overdue':'upcoming'):''}">${formatDate(t.planTime)}</div>
		   </div>
		   <div class="todo-title">${t.title}</div>`;

		 if(showDetails && t.details){
		   const det = t.details.length>100 ? t.details.substring(0,100)+'â€¦' : t.details;
		   html += `<div class="todo-details">${det}</div>`;
		 }
		 item.innerHTML = html;
		 list.appendChild(item);
	  });

	  if(showTodos.length===0){
		 list.innerHTML = '<p style="text-align:center;color:#999">æ— åŒ¹é…äº‹é¡¹</p>';
	  }
	}
	/* åˆ é™¤å½“å‰æ­£åœ¨ç¼–è¾‘çš„äº‹é¡¹ */
function delCurrentTodo() {
  if (!editingId) return;          // æ–°å»ºçŠ¶æ€æ—  ID
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥äº‹é¡¹å—ï¼Ÿ')) return;

  todos = todos.filter(t => t.id !== editingId);
  saveTodos();
  renderTodos();
  closeModal();                    // å…³é—­ç¼–è¾‘é¢æ¿
}
    </script>
</body>
</html>